#!/bin/bash
set -eu -o pipefail

ENVIRONMENT="${ENVIRONMENT:?"ENVIRONMENT not set"}"

export GOPATH="${PWD}"
export PATH="${PATH}:${GOPATH}/bin"

source routing-ci/scripts/script_helpers.sh

CF_VARS_STORE_PATH="$PWD/deployments-routing/${ENVIRONMENT}/deployment-vars.yml"
export CF_VARS_STORE_PATH

BBL_STATE="$PWD/deployments-routing/${ENVIRONMENT}/bbl-state"

pushd bbr-binary-release
  tar xvf ./*.tar
  BBR_BUILD_PATH="$PWD/releases/bbr"
  export BBR_BUILD_PATH
  ls -la "$BBR_BUILD_PATH"
  file "$BBR_BUILD_PATH"
popd

rm -f ~/.gitconfig

bosh_login "${ENVIRONMENT}"

export CF_ADMIN_PASSWORD=$(extract_var "${ENVIRONMENT}" cf_admin_password)
export NFS_BROKER_PASSWORD=$(extract_var "${ENVIRONMENT}" nfs-broker-password)
if [[ ! -z "${NFS_BROKER_PASSWORD}" ]]; then
  export NFS_SERVICE_NAME="nfs"
  export NFS_PLAN_NAME="Existing"
  export NFS_BROKER_USER="nfs-broker"
  export NFS_BROKER_URL="http://nfs-broker.${CF_DOMAIN}"
else
  echo "Skipping cf-nfsrboker testcase because nfs-broker-password is not present in ${CF_VARS_STORE_PATH}"
  if [[ -z "${SKIP_SUITE_NAME}" ]]; then
      export SKIP_SUITE_NAME="cf-nfsbroker"
  else
      export SKIP_SUITE_NAME="(${SKIP_SUITE_NAME})|cf-nfsbroker"
  fi
fi

pushd "$BBL_STATE"
  bbl version
  CF_DOMAIN=$(jq .lb.domain bbl-state.json -r)
  export CF_API_URL="https://api.${CF_DOMAIN}"
popd

echo "Running DRATs..."
cd src/github.com/cloudfoundry-incubator/disaster-recovery-acceptance-tests
source ./scripts/_run_acceptance_tests.sh
